<!DOCTYPE html>
<html lang="zh-Hant">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ°´è±šå›æœå°‹å¼•æ“</title>
    <link href="main.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script type="module" src="main.js"></script>
    <script type="module" src="cart.js"></script>
</head>

<body>

    <div id="app" class="container">
        <div class="sticky-header">
            <div class="search-container">
                <div style="display: flex; align-items: center; justify-content: center; text-align: center; height: 60px;margin: 20px;">
                    <img src="capy.png" alt="æ°´è±š" class="logo-icon" style="margin-right: -30px;margin-bottom: 20px;">
                    <h1 style="color: black; font-weight: 700;width: 100%;font-size: 28px;">æ°´è±šå›æœå°‹å¼•æ“</h1>
                    <input type="text" id="barcode-input" v-model="searchKeyword" placeholder="è«‹è¼¸å…¥å•†å“åç¨±" class="search-input">
                    <button onclick="startScanner()" style="background: transparent; border: none; padding: 0; cursor: pointer;">
                        <img src="camera.svg" alt="ç›¸æ©Ÿ" class="camera-icon">
                    </button>
                    <button @click="toggleCart" class="cart-toggle-button">
                        <img src="cart.png" alt="è³¼ç‰©è»Š" class="cart-icon">
                    </button>
                    <div id="name-display"></div>
                </div>
            </div>
        </div>

        <div>
            <label for="attribute">é¸æ“‡å±¬æ€§:</label>
            <select id="attribute" v-model="selectedAttribute">
                <option value="">å…¨éƒ¨</option>
                <option value="new">è²·ä¸€é€ä¸€</option>
                <option value="popular">ç†±é–€</option>
                <option value="sale">ä¿ƒéŠ·</option>
            </select>
        </div>

        <div id="scanner-container"></div>
        <div id="productList" class="product-list">
            <div v-for="product in filteredProducts" :key="product.name" class="product-item">
                <img :src="'æ–°å¢è³‡æ–™å¤¾/' + product.image" :alt="product.name" class="product-image">
                <h3>{{ product.name }}</h3>
                <p class="price">åƒ¹æ ¼: <span class="price-amount">${{ parsePrice(product.price) }}</span></p>
                <p v-if="product.description">{{ product.description }}</p>
                <div class="product-footer">
                    <div class="quantity-container">
                        <button @click="decreaseQuantity(product)" class="quantity-button">
                            <img src="remove.svg" alt="æ¸›å°‘" class="quantity-image">
                        </button>
                        <span class="quantity-display">{{ getProductQuantity(product) }}</span>
                        <button @click="increaseQuantity(product)" class="quantity-button">
                            <img src="add.svg" alt="å¢åŠ " class="quantity-image">
                        </button>
                    </div>
                </div>
            </div>
        </div>
        <div id="cart" class="cart" :class="{ show: isCartVisible }">
            <div class="cart-header">
                <button @click="toggleCart" class="return-toggle-button">
                    <img src="return.png" alt="return" class="return-icon">
                </button>
                <h2 style="margin:0px 10px 0px 0px;padding: 0;">è³¼ç‰©è»Š</h2><button @click="captureCart" class="screenshot-button">ä¸‹è¼‰è³¼ç‰©è»Šæˆªåœ–</button>
            </div>

            <div id="app" class="container">
                <button class="add-custom-product-button" @click="isAddingCustomProduct = true">æ–°å¢è‡ªè¨‚å•†å“</button>


                <div v-if="isAddingCustomProduct" class="custom-product-form">
                    <h2>æ–°å¢è‡ªè¨‚å•†å“</h2>
                    <input type="text" v-model="customProduct.name" placeholder="å•†å“åç¨±">
                    <input type="number" v-model="customProduct.price" placeholder="åƒ¹æ ¼">
                    <input type="file" @change="onFileChange" accept="image/*">
                    <button @click="addCustomProduct">åŠ å…¥è³¼ç‰©è»Š</button>
                    <button @click="isAddingCustomProduct = false">å–æ¶ˆ</button>
                </div>
            </div>

            <div class="cart-content">
                <div v-for="item in cart" :key="item.product.name" class="cart-item">
                    <div class="cart-item-info">
                        <img :src="item.product.file ? item.product.image : 'æ–°å¢è³‡æ–™å¤¾/' + item.product.image" :alt="item.product.name" class="cart-image">
                        <div class="cart-item-details">
                            <span class="cart-item-name">{{ item.product.name }}</span>
                            <span class="cart-item-price">å–®åƒ¹: ${{ parsePrice(item.product.price) }}</span>
                            <button @click="editPrice(item)" class="edit-price-button">ä¿®æ”¹å–®åƒ¹</button>
                        </div>
                    </div>
                    <div class="cart-item-quantity">
                        <button @click="decreaseQuantity(item.product)" class="quantity-button">
                            <img src="remove2.png" alt="æ¸›å°‘" class="quantity-image" style="width: 20px;height: 5px;">
                        </button>
                        <span style="font-size: 20px;">{{ item.quantity }}</span>
                        <button @click="increaseQuantity(item.product)" class="quantity-button">
                            <img src="add.png" alt="å¢åŠ " class="quantity-image">
                        </button>
                        <button @click="removeFromCart(item)" class="remove-button">åˆªé™¤</button>
                    </div>
                    <hr><br>
                    <div class="cart-item-subtotal">
                        å°è¨ˆ: ${{ (Number(item.subtotal) || 0).toFixed(2) }}
                        <button @click="editSubtotal(item)" class="edit-subtotal-button">ä¿®æ”¹</button>
                    </div>
                </div>
            </div>
            <div class="cart-total">
                <h3>ç¸½è¨ˆ: ${{ (Number(cartTotal) || 0).toFixed(0) }}å…ƒ</h3>
            </div>
        </div>
        <script>


            // å‰µå»ºVueå¯¦ä¾‹
            const app = new Vue({
                el: '#app',
                data: {
                    searchKeyword: '',
                    selectedAttribute: '',
                    products: [],
                    visibleProducts: [],
                    cart: [],
                    isCartVisible: false,
                    itemsPerLoad: 30,
                    currentIndex: 0,
                    customProduct: {
                        name: '',
                        price: '',
                        image: 'default.png', // é è¨­åœ–ç‰‡

                        barcode: null,
                        attributes: [],
                        specialOffers: null,
                        file: null, // æ–°å¢ file å±¬æ€§
                    },
                    isAddingCustomProduct: false,
                    cartModule: null, // ç”¨æ–¼å­˜å„²å°å…¥çš„cart.jsæ¨¡å¡Š
                },
                computed: {
                    filteredProducts() {
                        const keyword = this.searchKeyword.trim().toLowerCase();
                        const attribute = this.selectedAttribute.trim().toLowerCase();

                        const allFilteredProducts = this.products.filter(product => {
                            const nameMatches = product.name.toLowerCase().includes(keyword);
                            const barcodeMatches = product.barcode && product.barcode.includes(keyword);
                            const attributeMatches = attribute === '' ||
                                (product.attributes && product.attributes.includes(attribute));
                            return (nameMatches || barcodeMatches) && attributeMatches;
                        });

                        return allFilteredProducts.slice(0, this.currentIndex);
                    },
                    cartTotal() {
                        return this.cart.reduce((total, item) => total + Number(item.subtotal || 0), 0);
                    }
                },
                methods: {
                    calculateSubtotal(product, quantity) {
                        if (!product.specialOffers) {
                            return this.parsePrice(product.price) * quantity;
                        }

                        let subtotal = 0;
                        let remainingQuantity = quantity;

                        const offerKeys = Object.keys(product.specialOffers).map(Number).sort((a, b) => b - a);

                        for (let offerQty of offerKeys) {
                            while (remainingQuantity >= offerQty) {
                                subtotal += product.specialOffers[offerQty];
                                remainingQuantity -= offerQty;
                            }
                        }

                        if (remainingQuantity > 0) {
                            subtotal += this.parsePrice(product.price) * remainingQuantity;
                        }

                        return subtotal;
                    },
                    parsePrice(priceString) {
                        return parseFloat(priceString.replace(/[^\d.-]/g, '')) || 0;
                    },
                    addToCart(product) {
                        if (this.cartModule) {
                            // ä½¿ç”¨cart.jsæ¨¡å¡Šæ·»åŠ å•†å“
                            this.cart = this.cartModule.addToCart(product);
                        } else {
                            // å‚™ç”¨æ–¹æ¡ˆï¼šç›´æ¥æ“ä½œcartæ•¸çµ„
                            const cartItem = this.cart.find(item => item.product.name === product.name);
                            if (cartItem) {
                                cartItem.quantity++;
                            } else {
                                this.cart.push({
                                    product,
                                    quantity: 1
                                });
                            }
                            this.updateCartTotals();
                        }
                    },
                    increaseQuantity(product) {
                        if (this.cartModule) {
                            // ä½¿ç”¨cart.jsæ¨¡å¡Šå¢åŠ æ•¸é‡
                            this.cart = this.cartModule.addToCart(product);
                        } else {
                            this.addToCart(product);
                        }
                    },
                    decreaseQuantity(product) {
                        if (this.cartModule) {
                            // ä½¿ç”¨cart.jsæ¨¡å¡Šæ¸›å°‘æ•¸é‡
                            const cartItem = this.cart.find(item => item.product.name === product.name);
                            if (cartItem) {
                                const newQuantity = cartItem.quantity - 1;
                                if (newQuantity > 0) {
                                    this.cart = this.cartModule.updateQuantity(product.name, newQuantity);
                                } else {
                                    this.cart = this.cartModule.removeFromCart(product.name);
                                }
                            }
                        } else {
                            // å‚™ç”¨æ–¹æ¡ˆï¼šç›´æ¥æ“ä½œcartæ•¸çµ„
                            const cartItem = this.cart.find(item => item.product.name === product.name);
                            if (cartItem && cartItem.quantity > 1) {
                                cartItem.quantity--;
                            } else {
                                this.cart = this.cart.filter(item => item.product.name !== product.name);
                            }
                            this.updateCartTotals();
                        }
                    },
                    updateCartTotals() {
                        if (this.cartModule) {
                            // ä½¿ç”¨cart.jsæ¨¡å¡Šçš„è¨ˆç®—æ–¹æ³•
                            this.cart.forEach((item, index) => {
                                this.$set(item, 'subtotal', this.cartModule.calculateSubtotal(item.product, item.quantity));
                            });
                        } else {
                            // å‚™ç”¨æ–¹æ¡ˆï¼šä½¿ç”¨æœ¬åœ°è¨ˆç®—æ–¹æ³•
                            this.cart.forEach((item, index) => {
                                this.$set(item, 'subtotal', this.calculateSubtotal(item.product, item.quantity));
                            });
                        }
                    },
                    removeFromCart(item) {
                        if (this.cartModule) {
                            // ä½¿ç”¨cart.jsæ¨¡å¡Šç§»é™¤å•†å“
                            this.cart = this.cartModule.removeFromCart(item.product.name);
                        } else {
                            // å‚™ç”¨æ–¹æ¡ˆï¼šç›´æ¥æ“ä½œcartæ•¸çµ„
                            this.cart = this.cart.filter(cartItem => cartItem !== item);
                            this.updateCartTotals();
                        }
                    },
                    toggleCart() {
                        this.isCartVisible = !this.isCartVisible;
                    },
                    getProductQuantity(product) {
                        const cartItem = this.cart.find(item => item.product.name === product.name);
                        return cartItem ? cartItem.quantity : 0;
                    },
                    editSubtotal(item) {
                        const newSubtotal = prompt(`è«‹è¼¸å…¥æ–°çš„å°è¨ˆé‡‘é¡ (ç›®å‰ç‚º $${(Number(item.subtotal) || 0).toFixed(2)}):`);
                        if (newSubtotal !== null && !isNaN(newSubtotal) && newSubtotal >= 0) {
                            if (this.cartModule) {
                                // ä½¿ç”¨cart.jsæ¨¡å¡Šæ›´æ–°å°è¨ˆ
                                if (this.cartModule.updateSubtotal(item.product.name, parseFloat(newSubtotal))) {
                                    // æ›´æ–°Vueå¯¦ä¾‹ä¸­çš„è³¼ç‰©è»Šæ•¸æ“š
                                    this.cart = this.cartModule.getCart();
                                }
                            } else {
                                // å‚™ç”¨æ–¹æ¡ˆï¼šç›´æ¥æ›´æ–°å°è¨ˆ
                                this.$set(item, 'subtotal', parseFloat(newSubtotal));
                            }
                        } else {
                            alert('è«‹è¼¸å…¥æœ‰æ•ˆçš„å°è¨ˆé‡‘é¡');
                        }
                    },
                    editPrice(item) {
                        const newPrice = prompt(`è«‹è¼¸å…¥æ–°çš„å–®åƒ¹ (ç›®å‰ç‚º $${this.parsePrice(item.product.price)}):`); 
                        if (newPrice !== null && !isNaN(newPrice) && newPrice >= 0) {
                            // å°å…¥cart.jsä¸­çš„updatePriceå‡½æ•¸
                            import('./cart.js')
                                .then(cartModule => {
                                    // æ›´æ–°è³¼ç‰©è»Šä¸­çš„åƒ¹æ ¼
                                    const result = cartModule.updatePrice(item.product.name, newPrice);
                                    if (result.success) {
                                        // åŒæ­¥æ›´æ–°Vueå¯¦ä¾‹ä¸­çš„è³¼ç‰©è»Šæ•¸æ“š
                                        this.cart = cartModule.getCart();
                                        
                                        // åŒæ­¥æ›´æ–°åŸå§‹productsæ•¸çµ„ä¸­çš„åƒ¹æ ¼
                                        const productIndex = this.products.findIndex(p => p.name === item.product.name);
                                        if (productIndex !== -1) {
                                            // æ›´æ–°åŸå§‹æ•¸æ“šä¸­çš„åƒ¹æ ¼
                                            this.$set(this.products[productIndex], 'price', newPrice);
                                            // å¦‚æœåŸå§‹æ•¸æ“šä¸­æœ‰ç‰¹åƒ¹ä¿¡æ¯ï¼Œä¹Ÿéœ€è¦æ¸…é™¤
                                            if (this.products[productIndex].specialOffers) {
                                                this.$delete(this.products[productIndex], 'specialOffers');
                                            }
                                            console.log(`å·²æ›´æ–°å•†å“ "${item.product.name}" çš„åƒ¹æ ¼ç‚º ${newPrice}`);
                                            
                                            // å‘æœå‹™å™¨ç™¼é€è«‹æ±‚æ›´æ–°main.jsonæ–‡ä»¶
                                            fetch('http://localhost:3002/update-price', {
                                                method: 'POST',
                                                headers: {
                                                    'Content-Type': 'application/json'
                                                },
                                                body: JSON.stringify({
                                                    productName: item.product.name,
                                                    newPrice: newPrice // ç›´æ¥ç™¼é€å­—ç¬¦ä¸²æ ¼å¼çš„åƒ¹æ ¼
                                                })
                                            })
                                            .then(response => {
                                                if (!response.ok) {
                                                    return response.text().then(text => { throw new Error(text) });
                                                }
                                                return response.json();
                                            })
                                            .then(data => {
                                                Swal.fire('æˆåŠŸ', 'åƒ¹æ ¼å·²æ›´æ–°', 'success');
                                            })
                                            .catch(error => {
                                                console.error('è«‹æ±‚å¤±æ•—:', error);
                                                // æª¢æŸ¥æ˜¯å¦ç‚ºé€£æ¥éŒ¯èª¤
                                                if (error.message && error.message.includes('Failed to fetch')) {
                                                    Swal.fire('é€£æ¥éŒ¯èª¤', 'ç„¡æ³•é€£æ¥åˆ°æœå‹™å™¨ï¼Œè«‹ç¢ºä¿æœå‹™å™¨å·²å•Ÿå‹•ã€‚åƒ¹æ ¼å·²åœ¨è³¼ç‰©è»Šä¸­æ›´æ–°ï¼Œä½†æœªä¿å­˜åˆ°æ•¸æ“šåº«ã€‚', 'warning');
                                                } else {
                                                    Swal.fire('éŒ¯èª¤', error.toString(), 'error');
                                                }
                                            });
                                        }
                                    } else {
                                        Swal.fire('éŒ¯èª¤', result.message || 'æ›´æ–°åƒ¹æ ¼å¤±æ•—', 'error');
                                    }
                                })
                                .catch(error => {
                                    console.error('è¼‰å…¥è³¼ç‰©è»Šæ¨¡å¡Šå¤±æ•—:', error);
                                    Swal.fire('éŒ¯èª¤', 'è¼‰å…¥è³¼ç‰©è»Šæ¨¡å¡Šå¤±æ•—', 'error');
                                });
                        } else {
                            alert('è«‹è¼¸å…¥æœ‰æ•ˆçš„åƒ¹æ ¼');
                        }
                    },
                    captureCart() {
                        const cartElement = document.querySelector('#cart');
                        if (cartElement) {
                            const originalStyle = cartElement.getAttribute("style") || "";
                            cartElement.style.height = "auto";
                            cartElement.style.overflow = "visible";

                            html2canvas(cartElement, {
                                scale: 2,
                                useCORS: true,
                                windowWidth: cartElement.scrollWidth,
                                windowHeight: cartElement.scrollHeight,
                            }).then(canvas => {
                                const link = document.createElement('a');
                                link.download = 'è³¼ç‰©è»Š.png';
                                link.href = canvas.toDataURL('image/png');
                                link.click();

                                cartElement.setAttribute("style", originalStyle);
                            }).catch(error => {
                                console.error('æˆªåœ–å¤±æ•—:', error);
                                alert('æˆªåœ–éç¨‹ä¸­å‡ºç¾éŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦');
                                cartElement.setAttribute("style", originalStyle);
                            });
                        } else {
                            alert('ç„¡æ³•æ‰¾åˆ°è³¼ç‰©è»Šå…ƒç´ ');
                        }
                    },
                    loadMoreProducts() {
                        const nextIndex = this.currentIndex + this.itemsPerLoad;
                        const newProducts = this.products.slice(this.currentIndex, nextIndex);
                        this.visibleProducts.push(...newProducts);
                        this.currentIndex = nextIndex;
                    },
                    handleScroll() {
                        if (window.innerHeight + window.scrollY >= document.documentElement.scrollHeight - 50) {
                            this.loadMoreProducts();
                        }
                    },
                    onFileChange(event) {
                        const file = event.target.files[0];
                        if (file) {
                            this.customProduct.file = file;
                            this.customProduct.image = URL.createObjectURL(file); // é è¦½åœ–ç‰‡
                        }
                    },
                    addCustomProduct() {
                        if (!this.customProduct.name || !this.customProduct.price) {
                            alert('è«‹è¼¸å…¥å•†å“åç¨±å’Œåƒ¹æ ¼');
                            return;
                        }

                        const newProduct = {...this.customProduct};
                        
                        if (this.cartModule) {
                            // ä½¿ç”¨cart.jsæ¨¡å¡Šæ·»åŠ è‡ªå®šç¾©å•†å“
                            this.cart = this.cartModule.addToCart(newProduct);
                        } else {
                            // å‚™ç”¨æ–¹æ¡ˆï¼šä½¿ç”¨æœ¬åœ°æ–¹æ³•
                            this.addToCart(newProduct);
                        }
                        
                        this.customProduct = {
                            name: '',
                            price: '',
                            image: 'default.png',
                            barcode: null,
                            attributes: [],
                            specialOffers: null,
                            file: null
                        };
                        this.isAddingCustomProduct = false;
                    },
                },
                created() {
  // ğŸ”„ è¼‰å…¥ main.json å•†å“è³‡æ–™
  fetch('main.json')
    .then(response => response.json())
    .then(data => {
      this.products = data;
      this.loadMoreProducts(); // åˆå§‹åˆ†æ‰¹è¼‰å…¥
    })
    .catch(error => {
      console.error('è¼‰å…¥ main.json æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š', error);
      alert('ç„¡æ³•è¼‰å…¥å•†å“è³‡æ–™ï¼Œè«‹æª¢æŸ¥ main.json è·¯å¾‘');
    });

  // ğŸ›’ è¼‰å…¥è³¼ç‰©è»Šæ¨¡çµ„
  import('./cart.js')
    .then(module => {
      this.cartModule = module;
      this.cart = module.initCart();
    })
    .catch(error => console.error('åŠ è¼‰è³¼ç‰©è»Šæ¨¡å¡Šæ™‚å‡ºéŒ¯ï¼š', error));

  window.addEventListener('scroll', this.handleScroll);
},
                watch: {
                    searchKeyword() {
                        clearTimeout(this.searchTimeout);
                        this.searchTimeout = setTimeout(() => {
                            window.scrollTo({
                                top: 0,
                                behavior: 'smooth'
                            });
                        }, 500);
                    }
                }
            });
            
            // å°‡Vueå¯¦ä¾‹è¨­ç½®ç‚ºå…¨å±€è®Šé‡ï¼Œä»¥ä¾¿å…¶ä»–æ¨¡å¡Šå¯ä»¥è¨ªå•
            window.app = app;
        </script>
    </div>
</body>

</html>